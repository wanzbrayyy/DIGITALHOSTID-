<%- include('../partials/header', { title: 'Program Afiliasi' }) %>

<style>
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
    .affiliate-link-input { width: 100%; padding: 12px 15px; border: 1px solid var(--nexus-border-color); border-radius: var(--nexus-radius); font-size: 1rem; background-color: #f9fafb; margin-top: 1rem; cursor: pointer; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    table th, table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--nexus-border-color); }
    table th { font-weight: 600; background-color: #f9fafb; }
    .status-pending { color: var(--nexus-warning); }
    .status-credited { color: var(--nexus-success); font-weight: bold; }
    .progress-bar-container { width: 100%; background-color: #eee; border-radius: 50px; margin-top: 1rem; }
    .progress-bar { height: 20px; background-color: var(--nexus-success); border-radius: 50px; text-align: center; color: white; font-size: 0.8rem; line-height: 20px; transition: width 0.5s ease; }
</style>

<h1><i class="fas fa-users"></i> Program Afiliasi</h1>
<p>Dapatkan saldo sebesar <strong>Rp <%= milestoneReward.toLocaleString('id-ID') %></strong> setiap kali Anda berhasil mengajak <strong><%= milestoneCount %> orang</strong> untuk bergabung!</p>

<div class="grid-2">
    <div class="card">
        <h3>Link Afiliasi Unik Anda</h3>
        <p>Bagikan link di bawah ini untuk memulai.</p>
        <input type="text" class="affiliate-link-input" value="<%= referralLink %>" readonly onclick="this.select()">
    </div>
     <div class="card">
        <h3>Total Saldo Anda</h3>
        <h2 style="font-size: 2.5rem; color: var(--nexus-success); margin-top: 1rem;">Rp <%= user.creditBalance.toLocaleString('id-ID') %></h2>
    </div>
</div>

<div class="card">
    <h3>Progress Payout Berikutnya</h3>
    <p>
        <% if (referralsNeeded === 0) { %>
            <strong>Selamat!</strong> Anda telah mencapai target dan akan segera menerima reward.
        <% } else { %>
            Anda membutuhkan <strong><%= referralsNeeded %> referral lagi</strong> untuk mendapatkan reward.
        <% } %>
    </p>
    <div class="progress-bar-container">
        <% const progressPercentage = (pendingCount / milestoneCount) * 100; %>
        <div class="progress-bar" style="width: <%= progressPercentage > 100 ? 100 : progressPercentage %>%;">
            <%= pendingCount %> / <%= milestoneCount %>
        </div>
    </div>
</div>

<div class="card">
    <h3>Riwayat Pengguna yang Anda Referensikan</h3>
     <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Pengguna</th>
                    <th>Tanggal Bergabung</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <% if(referrals && referrals.length > 0) { %>
                    <% referrals.forEach(ref => { %>
                        <tr>
                            <td><%= ref.referredUser ? ref.referredUser.name : 'Pengguna Dihapus' %></td>
                            <td><%= new Date(ref.createdAt).toLocaleDateString('id-ID') %></td>
                            <td><span class="status-<%= ref.status %>"><%= ref.status === 'pending' ? 'Tertunda' : 'Sukses (Sudah Dihitung)' %></span></td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr><td colspan="3" style="text-align: center; padding: 20px;">Belum ada pengguna yang bergabung melalui link Anda.</td></tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<%- include('../partials/footer') %>