<%- include('../partials/header', { title: title }) %>

<div class="card" style="max-width: 500px; margin: 2rem auto;">
    <h2><i class="fas fa-money-bill-wave"></i> Deposit Saldo Akun</h2>
    <p>Saldo saat ini: <strong style="color: var(--nexus-success);">Rp <%= user.creditBalance.toLocaleString('id-ID') %></strong></p>
    
    <form id="deposit-form" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label for="amount">Jumlah Deposit (IDR)</label>
            <input type="number" id="amount" class="form-control" min="10000" step="10000" value="50000" required>
            <small>Minimal deposit adalah Rp 10.000.</small>
        </div>
        <button type="submit" id="deposit-button" class="btn btn-primary" style="width: 100%;">Lanjutkan ke Pembayaran</button>
    </form>
</div>

<script src="https://app.midtrans.com/snap/snap.js" data-client-key="<%= clientKey %>"></script>
<script>
    const form = document.getElementById('deposit-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const amount = document.getElementById('amount').value;
        const btn = document.getElementById('deposit-button');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="border-left-color: white; width: 20px; height: 20px; margin: 0 auto;"></div>';

        try {
            const response = await fetch('/dashboard/deposit/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: parseInt(amount) })
            });
            
            const data = await response.json();
            if (response.ok) {
                snap.pay(data.token, {
                    onSuccess: function(result){ window.location.href = '/dashboard/invoices?status=success'; },
                    onPending: function(result){ window.location.href = '/dashboard/invoices?status=pending'; },
                    onError: function(result){ window.location.href = '/dashboard/deposit?status=error'; },
                    onClose: function(){
                        btn.disabled = false;
                        btn.innerHTML = 'Lanjutkan ke Pembayaran';
                    }
                });
            } else {
                throw new Error(data.error || 'Gagal memulai transaksi.');
            }
        } catch (error) {
            alert('Terjadi kesalahan: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = 'Lanjutkan ke Pembayaran';
        }
    });
</script>

<%- include('../partials/footer') %>