<%- include('../partials/header', { title: title }) %>

<style>
    /*
    ============================================
    --- DEPOSIT PAGE STYLING ---
    ============================================
    */
    .page-container {
        padding-top: 4rem;
        padding-bottom: 4rem;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
    }

    .deposit-card {
        width: 100%;
        max-width: 550px;
        background-color: white;
        border-radius: var(--border-radius-lg);
        padding: 2.5rem;
        box-shadow: var(--shadow-lg);
        text-align: center;
    }
    .deposit-card h2 {
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }
    .deposit-card h2 i {
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .current-balance {
        font-size: 1.1rem;
        color: var(--color-text-muted);
        margin-bottom: 2.5rem;
    }
    .current-balance strong {
        color: var(--color-success);
        font-weight: 700;
        font-size: 1.2rem;
    }

    /* Preset Amount Buttons */
    .preset-amounts {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .preset-btn {
        padding: 1rem;
        border-radius: var(--border-radius-md);
        border: 1px solid var(--color-border);
        background-color: var(--color-bg-light);
        color: var(--color-text-dark);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .preset-btn:hover {
        background-color: white;
        border-color: var(--color-primary-start);
        color: var(--color-primary-start);
        transform: translateY(-2px);
    }
    
    /* Deposit Form */
    .deposit-form { text-align: left; }
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--color-text-dark);
    }
    .form-group .form-control {
        width: 100%; padding: 16px 20px; border-radius: var(--border-radius-md);
        background-color: var(--color-bg-light); border: 1px solid var(--color-border);
        font-size: 1.2rem; font-weight: 700; text-align: center;
    }
    .form-group .form-control:focus {
        background-color: white; border-color: var(--color-primary-start);
        box-shadow: 0 0 0 3px rgba(74, 0, 224, 0.15); outline: none;
    }
    .form-group small { color: var(--color-text-muted); margin-top: 0.5rem; display: block; text-align: center; }

    .btn-submit {
        width: 100%; padding: 18px; font-size: 1.1rem; margin-top: 1.5rem;
    }
</style>

<div class="container page-container">
    <div class="deposit-card">
        <h2><i class="fas fa-money-bill-wave"></i> Deposit Saldo Akun</h2>
        <p class="current-balance">Saldo saat ini: <strong>Rp <%= user.creditBalance.toLocaleString('id-ID') %></strong></p>
        
        <div class="preset-amounts">
            <button class="preset-btn" onclick="setAmount(50000)">Rp 50.000</button>
            <button class="preset-btn" onclick="setAmount(100000)">Rp 100.000</button>
            <button class="preset-btn" onclick="setAmount(250000)">Rp 250.000</button>
        </div>
        
        <form id="deposit-form" class="deposit-form">
            <div class="form-group">
                <label for="amount">Atau Masukkan Jumlah Lain (IDR)</label>
                <input type="number" id="amount" class="form-control" min="10000" step="1000" value="50000" required>
                <small>Minimal deposit adalah Rp 10.000.</small>
            </div>
            <button type="submit" id="deposit-button" class="btn btn-primary btn-submit">Lanjutkan ke Pembayaran</button>
        </form>
    </div>
</div>

<script src="https://app.midtrans.com/snap/snap.js" data-client-key="<%= clientKey %>"></script>
<script>
    function setAmount(value) {
        document.getElementById('amount').value = value;
    }

    const form = document.getElementById('deposit-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const amount = document.getElementById('amount').value;
        const btn = document.getElementById('deposit-button');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="border-left-color: white; width: 20px; height: 20px; margin: 0 auto;"></div>';

        try {
            const response = await fetch('/dashboard/deposit/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: parseInt(amount) })
            });
            
            const data = await response.json();
            if (response.ok) {
                snap.pay(data.token, {
                    onSuccess: function(result){ window.location.href = '/dashboard/invoices?status=success'; },
                    onPending: function(result){ window.location.href = '/dashboard/invoices?status=pending'; },
                    onError: function(result){ window.location.href = '/dashboard/deposit?status=error'; },
                    onClose: function(){
                        btn.disabled = false;
                        btn.innerHTML = 'Lanjutkan ke Pembayaran';
                    }
                });
            } else {
                throw new Error(data.error || 'Gagal memulai transaksi.');
            }
        } catch (error) {
            alert('Terjadi kesalahan: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = 'Lanjutkan ke Pembayaran';
        }
    });
</script>

<%- include('../partials/footer') %>